* Harvesting Notes
:PROPERTIES:
:header-args:http: :host http://localhost:3030 :user admin:quinnisgreat
:header-args:sparqlx: :url http://sparql.org/sparql :format text/csv
:header-args:sparql: :url http://localhost:3030/experts_private/sparql :format text/csv
:END:

** Manual Updates to the rc database

#+BEGIN_SRC bash
dc pull
dc down
update .env for testing
dc up -d

# Just fetch the experts graph.
experts_git=gitlab.dams.library.ucdavis.edu/experts/experts-data.git
docker-compose exec fuseki fuseki-import-graphs \
--clone="https://quinn:${GITLAB_PUSH_TOKEN}@${experts_git} \
--single-branch --branch=experts-dev" --graph=experts.ucdavis.edu

# Get users from other setup
src=http://gold.experts.library.ucdavis.edu:3005/experts/query
q='PREFIX : <http://experts.ucdavis.edu/schema#> select ?userId WHERE { [] a :person; :casId ?userId} order by ?userId'

users=$(http --print=b --follow ${src} query=="$q" Accept:text/csv | tail -n+2 | tr -s '\n\r' ' ')

dc exec harvest harvest -v login

for id in $users; do dc exec harvest harvest -v user --search=userId=$id --init --remove; done

# We have to make a special change for Kim, Sangtae
db=$(dc exec harvest harvest db new)
http --auth=admin:quinnisgreat http://localhost:8081/${db}/update Content-type:application/sparql-update <<<'
PREFIX experts_iam: <http://experts.ucdavis.edu/iam/>
PREFIX person: <http://experts.ucdavis.edu/person/>
PREFIX vivo: <http://vivoweb.org/ontology/core#>
delete { graph experts_iam: {person:1b9f745893ea8c821a3fc847e9775dbe a vivo:NonAcademic. } }
insert { graph experts_iam: {person:1b9f745893ea8c821a3fc847e9775dbe a vivo:FacultyMember. } }
WHERE {}'

dc exec harvest harvest rm $db

#+END_SRC

#+RESULTS:
: Email bug reports to:  bug-dc@gnu.org .

*** Exporting data

One you have all the data installed, you may like to:

#+BEGIN_SRC bash
dc exec harvest harvest export
#+END_SRC

#+BEGIN_SRC bash
branch=experts-dev
cd ~/experts-data
git checkout $branch
p=rp-ucd-deployment_harvest_1:/var/lib/harvest/export
docker cp $p/experts.ucdavis.edu%2Fiam/graph.ttl.gz  experts/experts.ucdavis.edu%2Fiam
gzip -d -f experts/experts.ucdavis.edu%2Fiam/graph.ttl.gz
docker cp $p/experts.ucdavis.edu%2Foap/graph.ttl.gz  experts/experts.ucdavis.edu%2Foap
docker cp $p/experts.ucdavis.edu%2Ffis/graph.ttl.gz  experts/experts.ucdavis.edu%2Ffis
gzip -d -f experts/experts.ucdavis.edu%2Ffis/graph.ttl.gz
#+END_SRC

*** Mulitple Users

You time the extent with 2 or three users by doing:


dc exec harvest harvest -v user --search=userId=quinn
dc exec harvest harvest -v user --search=userId=jrmerz

dc exec harvest harvest -v user --search=userId=quinn,jrmerz

#! /bin/make
users:=quinn jrmerz vensburg benthem

finished:=$(patsubst %,%.out ${users})   # finshe:=quinn.out jrmerz.out...

all:${finished}

${finished}:%.out
   time $(dc exec harvest harvest -v user --search=userId=$* --init --remove >
   $@) > $*.time



$> make -j 5 all 2

*** 2021-08010 Grants / hack

While are are waiting on the complete grants info. We can add the grants we do
have with:

#+BEGIN_SRC bash
experts_git=gitlab.dams.library.ucdavis.edu/experts/experts-data.git
docker-compose exec fuseki fuseki-import-graphs \
--clone="https://quinn:${GITLAB_PUSH_TOKEN}@${experts_git} \
--single-branch --branch=experts-dev" --graph=experts.ucdavis.edu%2Ffis

#+END_SRC
